import numpy as np
import pandas as pd
import yfinance as yf
import warnings
import requests
import riskfolio as rp
import urllib as urllib
from zipfile import ZipFile
import io
from io import StringIO
from io import BytesIO
from openpyxl import load_workbook


warnings.filterwarnings("ignore")
pd.options.display.float_format = '{:.4%}'.format

# Date range
Start = '2016-01-01'
End = '2019-12-30'

# Downloading parameters
def excel_download():
    holdings_url = "https://github.com/ra6it/RiskParity/blob/a4b0da6762b1352450213409b42bfa4f49f27f7f/RiskParity_Holdings.xlsx?raw=true"
    holdings_url = requests.get(holdings_url).content
    assets = pd.read_excel(holdings_url, usecols="A:B")
    assets = assets.reindex(columns=['Asset','Industry'])
    asset_classes = {'Asset': assets['Asset'].values.tolist(), 
                     'Industry': assets['Industry'].values.tolist()}
    asset_classes = pd.DataFrame(asset_classes)
    asset_classes = asset_classes.sort_values(by=['Asset'])

    constraint_url = "https://github.com/ra6it/RiskParity/blob/a4b0da6762b1352450213409b42bfa4f49f27f7f/RiskParity_Constraints.xlsx?raw=true"
    constraint_url = requests.get(constraint_url).content
    constraints = pd.read_excel(constraint_url,usecols="B:K")
    constraints=pd.DataFrame(constraints)
    print(constraints,asset_classes)
    return asset_classes, constraints
        
# Downloading data
def data_download(asset_classes):
    print("Downloading data...")
    asset = asset_classes['Asset'].to_string(index=False)
    print(asset)
    data = yf.download(asset, start = Start, end = End)
    data = data.loc[:,('Adj Close', slice(None))]
    Y = data.pct_change().dropna()
    return Y
    
# Select method and estimate input parameters:
def method():
    method_mu='hist' # Method to estimate expected returns based on historical data.
    method_cov='hist' # Method to estimate covariance matrix based on historical data.
    return method_mu, method_cov

def portfolio_object(assets,method_mu, method_cov):
    port = rp.Portfolio(returns=data_download(assets))
    port.assets_stats(method_mu=method_mu, method_cov=method_cov, d=0.94)
    return port

def create_pie(w):
    ax = rp.plot_pie(w=w, title='Sharpe Mean Variance', others=0.05, nrow=25, cmap = "tab20",
                 height=6, width=10, ax=None)

def efficient_frontier(model,rm,obj,hist,rf,l,points,port):
    frontier = port.efficient_frontier(model=model, rm=rm, points=points, rf=rf, hist=hist)

def constraints_weightings(constraints,asset_classes):
    asset_classes = pd.DataFrame(asset_classes)
    print(asset_classes)
    constraints = pd.DataFrame(constraints)
    A, B = rp.assets_constraints(constraints, asset_classes)
    return A, B

def ainequality(A,B, port):
    port.ainequality = A
    port.binequality = B
    print("here")
    w = port.optimization(model=model, rm=rm, obj=obj, rf=rf, l=l, hist=hist)
    print(w.T)

def runner(model,rm,obj,hist,rf,l,points):
    asset_classes, constraints = excel_download()
    method_mu, method_cov = method()
    port = portfolio_object(asset_classes,method_mu, method_cov)
    w = port.optimization(model=model, rm=rm, obj=obj, rf=rf, l=l, hist=hist)
    efficient_frontier(model,rm,obj,hist,rf,l,points, port)
    A,B = constraints_weightings(constraints,asset_classes)
    ainequality(A,B, port)
   

#########################################Parameters##########################################
model='Classic' # Could be Classic (historical), BL (Black Litterman) or FM (Factor Model)
rm = 'MV' # Risk measure used, this time will be variance
obj = 'Sharpe' # Objective function, could be MinRisk, MaxRet, Utility or Sharpe
hist = True # Use historical scenarios for risk measures that depend on scenarios
rf = 0 # Risk free rate
l = 1 # Risk aversion factor, only useful when obj is 'Utility'
points = 50 # Number of points of the frontier

runner(model,rm,obj,hist,rf,l,points)


